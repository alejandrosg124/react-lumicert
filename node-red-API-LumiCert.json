[
    {
        "id": "7c7613f3e7ca3f2d",
        "type": "tab",
        "label": "LumiCert API",
        "disabled": false,
        "info": ""
    },
    {
        "id": "3dc4fc1936dd6f62",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/consumo/total-mes",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 100,
        "wires": [
            [
                "fc40d0e21e982191"
            ]
        ]
    },
    {
        "id": "fc40d0e21e982191",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Preparar Query",
        "func": "const now = new Date();\nconst year = now.getFullYear();\nconst month = now.getMonth() + 1;\nconst daysInMonth = new Date(year, month, 0).getDate();\nconst currentDay = now.getDate();\n\nflow.set('year', year);\nflow.set('month', month);\nflow.set('daysInMonth', daysInMonth);\nflow.set('currentDay', currentDay);\n\n// Query que maneja fechas con y sin timezone\nmsg.collection = 'medicion';\nmsg.payload = [\n    {\n        $addFields: {\n            fechaNormalizada: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                    then: \"$fecha\",\n                    else: { $concat: [\"$fecha\", \"Z\"] }\n                }\n            }\n        }\n    },\n    {\n        $addFields: {\n            fechaDate: { \n                $dateFromString: { \n                    dateString: \"$fechaNormalizada\",\n                    onError: null\n                } \n            }\n        }\n    },\n    {\n        $match: {\n            fechaDate: { $ne: null }\n        }\n    },\n    {\n        $addFields: {\n            mes: { $month: \"$fechaDate\" },\n            anio: { $year: \"$fechaDate\" }\n        }\n    },\n    {\n        $match: {\n            mes: month,\n            anio: year\n        }\n    },\n    {\n        $group: {\n            _id: null,\n            totalConsumo: { $sum: \"$consumo\" },\n            count: { $sum: 1 }\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400,
        "y": 100,
        "wires": [
            [
                "0abf365b8084f8c3"
            ]
        ]
    },
    {
        "id": "0abf365b8084f8c3",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 640,
        "y": 100,
        "wires": [
            [
                "e26f50b3bde4dd60"
            ]
        ]
    },
    {
        "id": "e26f50b3bde4dd60",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Respuesta",
        "func": "const year = flow.get('year');\nconst month = flow.get('month');\nconst daysInMonth = flow.get('daysInMonth');\nconst currentDay = flow.get('currentDay');\n\nif (msg.payload && msg.payload.length > 0) {\n    const data = msg.payload[0];\n    const totalConsumo = data.totalConsumo || 0;\n    const promedioMes = totalConsumo / daysInMonth;\n    const promedioDiario = totalConsumo / currentDay;\n    \n    msg.payload = {\n        success: true,\n        data: {\n            consumoTotalMes: parseFloat(totalConsumo.toFixed(3)),\n            consumoPromedioDiario: parseFloat(promedioDiario.toFixed(3)),\n            consumoPromedioMes: parseFloat(promedioMes.toFixed(3)),\n            mes: month,\n            año: year,\n            diasTranscurridos: currentDay,\n            totalDiasMes: daysInMonth,\n            mediciones: data.count\n        }\n    };\n} else {\n    msg.payload = {\n        success: true,\n        data: {\n            consumoTotalMes: 0,\n            consumoPromedioDiario: 0,\n            consumoPromedioMes: 0,\n            mes: month,\n            año: year,\n            diasTranscurridos: currentDay,\n            totalDiasMes: daysInMonth,\n            mediciones: 0\n        }\n    };\n}\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 860,
        "y": 100,
        "wires": [
            [
                "8b7e73bb4071e956"
            ]
        ]
    },
    {
        "id": "8b7e73bb4071e956",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1090,
        "y": 100,
        "wires": []
    },
    {
        "id": "b382024c32f8f941",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 160,
        "wires": [
            [
                "705c3c6b245626bd"
            ]
        ]
    },
    {
        "id": "705c3c6b245626bd",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Sectores",
        "func": "msg.collection = 'sector';\nmsg.payload = {};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 160,
        "wires": [
            [
                "c1248d7e8c90c76f"
            ]
        ]
    },
    {
        "id": "c1248d7e8c90c76f",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "find",
        "x": 600,
        "y": 160,
        "wires": [
            [
                "47ae37730d1c7a0c"
            ]
        ]
    },
    {
        "id": "47ae37730d1c7a0c",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear",
        "func": "msg.payload = {\n    success: true,\n    data: msg.payload || []\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 160,
        "wires": [
            [
                "9e94f0d1672241f3"
            ]
        ]
    },
    {
        "id": "9e94f0d1672241f3",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 990,
        "y": 160,
        "wires": []
    },
    {
        "id": "ccf72dd9375d7d66",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/luminarias",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 220,
        "wires": [
            [
                "8f586771f0ff530d"
            ]
        ]
    },
    {
        "id": "8f586771f0ff530d",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Luminarias",
        "func": "msg.collection = 'luminarias';\nmsg.payload = {};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 220,
        "wires": [
            [
                "0d7f8a6c4704e3d0"
            ]
        ]
    },
    {
        "id": "0d7f8a6c4704e3d0",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "find",
        "x": 610,
        "y": 220,
        "wires": [
            [
                "3a56377d5911b56e"
            ]
        ]
    },
    {
        "id": "3a56377d5911b56e",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear",
        "func": "msg.payload = {\n    success: true,\n    data: msg.payload || [],\n    total: msg.payload ? msg.payload.length : 0\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 220,
        "wires": [
            [
                "2803ceee0e13f3b9"
            ]
        ]
    },
    {
        "id": "2803ceee0e13f3b9",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1010,
        "y": 220,
        "wires": []
    },
    {
        "id": "313160b9ccbfa7b4",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/notificaciones",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 280,
        "wires": [
            [
                "e2c0d101b371bb92"
            ]
        ]
    },
    {
        "id": "e2c0d101b371bb92",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Notificaciones",
        "func": "msg.collection = 'notificacion';\nmsg.payload = {};\nmsg.limit = 10;\nmsg.sort = { fecha: -1 };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 280,
        "wires": [
            [
                "a4ccec4ddacddad4"
            ]
        ]
    },
    {
        "id": "a4ccec4ddacddad4",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "find",
        "x": 660,
        "y": 280,
        "wires": [
            [
                "e00feda04a86c2ed"
            ]
        ]
    },
    {
        "id": "e00feda04a86c2ed",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear",
        "func": "const sortedData = (msg.payload || []).sort((a, b) => {\n    return new Date(b.fecha) - new Date(a.fecha);\n}).slice(0, 10);\n\nmsg.payload = {\n    success: true,\n    data: sortedData\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 280,
        "wires": [
            [
                "31624ee180ab6689"
            ]
        ]
    },
    {
        "id": "31624ee180ab6689",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1050,
        "y": 280,
        "wires": []
    },
    {
        "id": "8bf00def27963f8c",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/estadisticas",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 340,
        "wires": [
            [
                "0974db7c55609893"
            ]
        ]
    },
    {
        "id": "0974db7c55609893",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Estadísticas",
        "func": "// Agregación para obtener última medición de cada luminaria\nmsg.collection = 'medicion';\nmsg.payload = [\n    {\n        $addFields: {\n            fechaNormalizada: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                    then: \"$fecha\",\n                    else: { $concat: [\"$fecha\", \"Z\"] }\n                }\n            }\n        }\n    },\n    {\n        $addFields: {\n            fechaDate: { \n                $dateFromString: { \n                    dateString: \"$fechaNormalizada\",\n                    onError: null\n                } \n            }\n        }\n    },\n    {\n        $match: {\n            fechaDate: { $ne: null }\n        }\n    },\n    {\n        $sort: { id_luminaria: 1, fechaDate: -1 }\n    },\n    {\n        $group: {\n            _id: \"$id_luminaria\",\n            ultimaFalla: { $first: \"$falla\" },\n            ultimaFecha: { $first: \"$fechaDate\" }\n        }\n    },\n    {\n        $group: {\n            _id: null,\n            total: { $sum: 1 },\n            conFalla: {\n                $sum: {\n                    $cond: [{ $eq: [\"$ultimaFalla\", true] }, 1, 0]\n                }\n            }\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 340,
        "wires": [
            [
                "ba1b96b0c6f5487f"
            ]
        ]
    },
    {
        "id": "ba1b96b0c6f5487f",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 590,
        "y": 340,
        "wires": [
            [
                "bf348c0eee45c617"
            ]
        ]
    },
    {
        "id": "bf348c0eee45c617",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Estadísticas",
        "func": "let total = 0;\nlet conProblemas = 0;\n\nif (msg.payload && msg.payload.length > 0) {\n    const data = msg.payload[0];\n    total = data.total || 0;\n    conProblemas = data.conFalla || 0;\n}\n\nconst funcionando = total - conProblemas;\n\nmsg.payload = {\n    success: true,\n    data: {\n        totalLuminarias: total,\n        luminariasFuncionando: funcionando,\n        luminariasConProblemas: conProblemas\n    }\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 820,
        "y": 340,
        "wires": [
            [
                "fc246197ba6adad5"
            ]
        ]
    },
    {
        "id": "fc246197ba6adad5",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1050,
        "y": 340,
        "wires": []
    },
    {
        "id": "433d6b799af13aae",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/consumo/mes-anterior",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 400,
        "wires": [
            [
                "10b8c8834d3854c1"
            ]
        ]
    },
    {
        "id": "10b8c8834d3854c1",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Mes Anterior",
        "func": "const now = new Date();\nconst lastMonth = now.getMonth() === 0 ? 12 : now.getMonth();\nconst lastYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();\n\nflow.set('lastMonth', lastMonth);\nflow.set('lastYear', lastYear);\n\nmsg.collection = 'medicion';\nmsg.payload = [\n    {\n        $addFields: {\n            fechaNormalizada: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                    then: \"$fecha\",\n                    else: { $concat: [\"$fecha\", \"Z\"] }\n                }\n            }\n        }\n    },\n    {\n        $addFields: {\n            fechaDate: { \n                $dateFromString: { \n                    dateString: \"$fechaNormalizada\",\n                    onError: null\n                } \n            }\n        }\n    },\n    {\n        $match: {\n            fechaDate: { $ne: null }\n        }\n    },\n    {\n        $addFields: {\n            mes: { $month: \"$fechaDate\" },\n            anio: { $year: \"$fechaDate\" }\n        }\n    },\n    {\n        $match: {\n            mes: lastMonth,\n            anio: lastYear\n        }\n    },\n    {\n        $group: {\n            _id: null,\n            totalConsumo: { $sum: \"$consumo\" }\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 400,
        "wires": [
            [
                "40e8515cece3bdd9"
            ]
        ]
    },
    {
        "id": "40e8515cece3bdd9",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 680,
        "y": 400,
        "wires": [
            [
                "a1f0421d9727b1c8"
            ]
        ]
    },
    {
        "id": "a1f0421d9727b1c8",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear",
        "func": "const lastMonth = flow.get('lastMonth');\nconst lastYear = flow.get('lastYear');\n\nif (msg.payload && msg.payload.length > 0) {\n    msg.payload = {\n        success: true,\n        data: {\n            consumoMesAnterior: parseFloat(msg.payload[0].totalConsumo.toFixed(3)),\n            mes: lastMonth,\n            año: lastYear\n        }\n    };\n} else {\n    msg.payload = {\n        success: true,\n        data: {\n            consumoMesAnterior: 0,\n            mes: lastMonth,\n            año: lastYear\n        }\n    };\n}\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 850,
        "y": 400,
        "wires": [
            [
                "8b520c89bce5fa2c"
            ]
        ]
    },
    {
        "id": "8b520c89bce5fa2c",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1050,
        "y": 400,
        "wires": []
    },
    {
        "id": "c56b983d779a8fcc",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/*",
        "method": "options",
        "upload": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 460,
        "wires": [
            [
                "dad849a375841e14"
            ]
        ]
    },
    {
        "id": "dad849a375841e14",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "CORS Headers",
        "func": "msg.statusCode = 200;\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization'\n};\nmsg.payload = '';\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 440,
        "y": 460,
        "wires": [
            [
                "2f49a487c224f05a"
            ]
        ]
    },
    {
        "id": "2f49a487c224f05a",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 650,
        "y": 460,
        "wires": []
    },
    {
        "id": "c2997564aba72bc5",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/consumo/diario",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 520,
        "wires": [
            [
                "52f9dfbbfd085943"
            ]
        ]
    },
    {
        "id": "52f9dfbbfd085943",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Consumo Diario",
        "func": "const now = new Date();\nconst year = now.getFullYear();\nconst month = now.getMonth() + 1;\n\nmsg.collection = 'medicion';\nmsg.payload = [\n    {\n        $addFields: {\n            fechaNormalizada: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                    then: \"$fecha\",\n                    else: { $concat: [\"$fecha\", \"Z\"] }\n                }\n            }\n        }\n    },\n    {\n        $addFields: {\n            fechaDate: { \n                $dateFromString: { \n                    dateString: \"$fechaNormalizada\",\n                    onError: null\n                } \n            }\n        }\n    },\n    {\n        $match: {\n            fechaDate: { $ne: null }\n        }\n    },\n    {\n        $addFields: {\n            mes: { $month: \"$fechaDate\" },\n            anio: { $year: \"$fechaDate\" },\n            dia: { $dayOfMonth: \"$fechaDate\" }\n        }\n    },\n    {\n        $match: {\n            mes: month,\n            anio: year\n        }\n    },\n    {\n        $group: {\n            _id: \"$dia\",\n            consumoTotal: { $sum: \"$consumo\" }\n        }\n    },\n    {\n        $sort: { _id: 1 }\n    },\n    {\n        $project: {\n            _id: 0,\n            dia: \"$_id\",\n            consumo: { $round: [\"$consumoTotal\", 3] }\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 420,
        "y": 520,
        "wires": [
            [
                "1f67d09f5119d586"
            ]
        ]
    },
    {
        "id": "1f67d09f5119d586",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 680,
        "y": 520,
        "wires": [
            [
                "df25386714f1c23a"
            ]
        ]
    },
    {
        "id": "df25386714f1c23a",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Consumo Diario",
        "func": "msg.payload = {\n    success: true,\n    data: msg.payload || []\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 520,
        "wires": [
            [
                "624abd33c484b4e3"
            ]
        ]
    },
    {
        "id": "624abd33c484b4e3",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1130,
        "y": 520,
        "wires": []
    },
    {
        "id": "57b5a4adc299163f",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/consumo/por-hora",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 620,
        "wires": [
            [
                "c3527aeca2441023"
            ]
        ]
    },
    {
        "id": "c3527aeca2441023",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Consumo por Hora",
        "func": "msg.collection = 'medicion';\nmsg.payload = [\n    {\n        $addFields: {\n            fechaSplit: { $split: [\"$fecha\", \"T\"] }\n        }\n    },\n    {\n        $addFields: {\n            timePart: { $arrayElemAt: [\"$fechaSplit\", 1] }\n        }\n    },\n    {\n        $addFields: {\n            timeArray: { $split: [\"$timePart\", \":\"] }\n        }\n    },\n    {\n        $addFields: {\n            hora: { $toInt: { $arrayElemAt: [\"$timeArray\", 0] } }\n        }\n    },\n    {\n        $group: {\n            _id: \"$hora\",\n            totalConsumo: { $sum: \"$consumo\" },\n            count: { $sum: 1 }\n        }\n    },\n    {\n        $project: {\n            _id: 0,\n            hora: \"$_id\",\n            consumoPromedio: { $divide: [\"$totalConsumo\", \"$count\"] }\n        }\n    },\n    {\n        $sort: { hora: 1 }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 620,
        "wires": [
            [
                "907dc226a87e1a3a"
            ]
        ]
    },
    {
        "id": "907dc226a87e1a3a",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 670,
        "y": 620,
        "wires": [
            [
                "30fc1959c74fa151"
            ]
        ]
    },
    {
        "id": "30fc1959c74fa151",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Respuesta",
        "func": "msg.payload = {\n    success: true,\n    data: msg.payload\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 890,
        "y": 620,
        "wires": [
            [
                "f2025f9304210e9e"
            ]
        ]
    },
    {
        "id": "f2025f9304210e9e",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "statusCode": "200",
        "headers": {
            "Access-Control-Allow-Origin": "*",
            "Content-Type": "application/json"
        },
        "x": 1100,
        "y": 620,
        "wires": []
    },
    {
        "id": "8659f410e96a6b5c",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/consumo/por-hora",
        "method": "options",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 680,
        "wires": [
            [
                "a818876848e3c12e"
            ]
        ]
    },
    {
        "id": "a818876848e3c12e",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "statusCode": "204",
        "headers": {
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
            "Access-Control-Allow-Headers": "Content-Type, Authorization"
        },
        "x": 460,
        "y": 680,
        "wires": []
    },
    {
        "id": "b13f8acc811773ad",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/ultima-medicion",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 740,
        "wires": [
            [
                "866fedf094d56ec1"
            ]
        ]
    },
    {
        "id": "866fedf094d56ec1",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Última Medición",
        "func": "msg.collection = 'medicion';\nmsg.payload = [\n    {\n        $addFields: {\n            fechaSplit: { $split: [\"$fecha\", \"T\"] }\n        }\n    },\n    {\n        $addFields: {\n            fechaNormalizada: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                    then: \"$fecha\",\n                    else: { $concat: [\"$fecha\", \"Z\"] }\n                }\n            }\n        }\n    },\n    {\n        $addFields: {\n            fechaDate: { \n                $dateFromString: { \n                    dateString: \"$fechaNormalizada\",\n                    onError: null\n                } \n            }\n        }\n    },\n    {\n        $match: {\n            fechaDate: { $ne: null }\n        }\n    },\n    {\n        $sort: { fechaDate: -1 }\n    },\n    {\n        $limit: 1\n    },\n    {\n        $project: {\n            _id: 0,\n            fecha: 1,\n            consumo: 1,\n            estado_rele: 1,\n            perdida_energia: 1,\n            falla: 1,\n            sobreconsumo: 1,\n            corriente: 1,\n            voltaje: 1,\n            id_luminaria: 1\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 740,
        "wires": [
            [
                "68cb2acea1453ab7"
            ]
        ]
    },
    {
        "id": "68cb2acea1453ab7",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 690,
        "y": 740,
        "wires": [
            [
                "a2190d13ce54a6e7"
            ]
        ]
    },
    {
        "id": "a2190d13ce54a6e7",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Respuesta",
        "func": "const medicion = msg.payload[0] || null;\nmsg.payload = {\n    success: true,\n    data: medicion\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 930,
        "y": 740,
        "wires": [
            [
                "67f875e249c7cc01"
            ]
        ]
    },
    {
        "id": "67f875e249c7cc01",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "statusCode": "200",
        "headers": {
            "Access-Control-Allow-Origin": "*",
            "Content-Type": "application/json"
        },
        "x": 1160,
        "y": 740,
        "wires": []
    },
    {
        "id": "71139160118705d8",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/ultima-medicion",
        "method": "options",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 800,
        "wires": [
            [
                "227184d93bb93469"
            ]
        ]
    },
    {
        "id": "227184d93bb93469",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "statusCode": "204",
        "headers": {
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
            "Access-Control-Allow-Headers": "Content-Type, Authorization"
        },
        "x": 490,
        "y": 800,
        "wires": []
    },
    {
        "id": "f946d095db8189a8",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 860,
        "wires": [
            [
                "85b1a0aa44df270a"
            ]
        ]
    },
    {
        "id": "85b1a0aa44df270a",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Create Sector",
        "func": "const { nombre, zona } = msg.payload;\n\nif (!nombre || !zona) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: 'Nombre y zona son requeridos'\n    };\n    return msg;\n}\n\nmsg.collection = 'sector';\nconst newSector = {\n    nombre: nombre,\n    zona: zona,\n    luminarias: []\n};\nmsg.payload = newSector;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 860,
        "wires": [
            [
                "dd00b55d17cffb34",
                "4ee4c64a995aea1f"
            ]
        ]
    },
    {
        "id": "dd00b55d17cffb34",
        "type": "mongodb out",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "insert",
        "x": 610,
        "y": 860,
        "wires": []
    },
    {
        "id": "4ee4c64a995aea1f",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Format Response",
        "func": "msg.statusCode = 201;\nmsg.payload = {\n    success: true,\n    message: 'Sector creado exitosamente'\n};\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 860,
        "wires": [
            [
                "2207bf316f7cb38f"
            ]
        ]
    },
    {
        "id": "2207bf316f7cb38f",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1040,
        "y": 860,
        "wires": []
    },
    {
        "id": "69ad9da2f4838149",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores/:id",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 920,
        "wires": [
            [
                "0feb9c6a6bac815e"
            ]
        ]
    },
    {
        "id": "0feb9c6a6bac815e",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Update Sector",
        "func": "const sectorId = msg.req.params.id;\nconst { nombre, zona } = msg.payload;\n\nif (!nombre && !zona) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: 'Debe proporcionar al menos nombre o zona'\n    };\n    return msg;\n}\n\nlet updateFields = {};\nif (nombre) updateFields.nombre = nombre;\nif (zona) updateFields.zona = zona;\n\nmsg.collection = 'sector';\n// Intentamos usar el ID como string, el nodo mongodb debería manejarlo si es posible\n// O usamos _id directamente si el nodo lo soporta\nmsg.query = { _id: sectorId };\nmsg.payload = { $set: updateFields };\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400,
        "y": 920,
        "wires": [
            [
                "343b80363bd7fc3b",
                "2630960b58d0cbe9"
            ]
        ]
    },
    {
        "id": "343b80363bd7fc3b",
        "type": "mongodb out",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "payonly": false,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 620,
        "y": 920,
        "wires": []
    },
    {
        "id": "2630960b58d0cbe9",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Format Response",
        "func": "msg.statusCode = 200;\nmsg.payload = {\n    success: true,\n    message: 'Sector actualizado exitosamente'\n};\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 920,
        "wires": [
            [
                "3816147f3f3dd099"
            ]
        ]
    },
    {
        "id": "3816147f3f3dd099",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1040,
        "y": 920,
        "wires": []
    },
    {
        "id": "6dc4ce69c20740f9",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores/:id/luminarias",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 980,
        "wires": [
            [
                "6a0b32afa34f63c6"
            ]
        ]
    },
    {
        "id": "6a0b32afa34f63c6",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Link Luminarias",
        "func": "const sectorId = msg.req.params.id;\nconst { luminarias } = msg.payload;\n\nif (!Array.isArray(luminarias)) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: 'luminarias debe ser un array'\n    };\n    return msg;\n}\n\n// Usamos id_lum (strings) en lugar de ObjectIDs\nconst luminariaIds = luminarias;\n\nmsg.collection = 'sector';\nmsg.query = { _id: sectorId };\nmsg.payload = { $set: { luminarias: luminariaIds } };\n\nflow.set('sectorId', sectorId);\nflow.set('luminariaIds', luminariaIds);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 980,
        "wires": [
            [
                "816e507f3e0978e7",
                "baf2da0d4a980c1b"
            ]
        ]
    },
    {
        "id": "816e507f3e0978e7",
        "type": "mongodb out",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "payonly": false,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 660,
        "y": 980,
        "wires": []
    },
    {
        "id": "baf2da0d4a980c1b",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Update Luminarias Sector",
        "func": "const sectorId = flow.get('sectorId');\nconst luminariaIds = flow.get('luminariaIds');\n\nmsg.collection = 'luminarias';\n// Buscamos por id_lum que es string, evitando problemas con ObjectID\nmsg.query = { id_lum: { $in: luminariaIds } };\nmsg.payload = { $set: { id_sector: sectorId } };\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 890,
        "y": 980,
        "wires": [
            [
                "22a3b4e67d165333",
                "fe7130fde4cdb0c5"
            ]
        ]
    },
    {
        "id": "22a3b4e67d165333",
        "type": "mongodb out",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "payonly": false,
        "upsert": false,
        "multi": true,
        "operation": "update",
        "x": 1140,
        "y": 980,
        "wires": []
    },
    {
        "id": "fe7130fde4cdb0c5",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Format Response",
        "func": "msg.statusCode = 200;\nmsg.payload = {\n    success: true,\n    message: 'Luminarias enlazadas exitosamente'\n};\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1370,
        "y": 980,
        "wires": [
            [
                "bfbb42f6e9e256cf"
            ]
        ]
    },
    {
        "id": "bfbb42f6e9e256cf",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1580,
        "y": 980,
        "wires": []
    },
    {
        "id": "115b68a0eea4fdca",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores/:id",
        "method": "delete",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 1040,
        "wires": [
            [
                "b736acdb2c466e7e"
            ]
        ]
    },
    {
        "id": "b736acdb2c466e7e",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Delete Sector",
        "func": "const sectorId = msg.req.params.id;\n\nmsg.collection = 'sector';\nmsg.query = { _id: sectorId };\n\nflow.set('deleteSectorId', sectorId);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400,
        "y": 1040,
        "wires": [
            [
                "91f0a309b553cf3c",
                "5f5325030cd4f6c0"
            ]
        ]
    },
    {
        "id": "91f0a309b553cf3c",
        "type": "mongodb out",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "payonly": false,
        "upsert": false,
        "multi": false,
        "operation": "delete",
        "x": 610,
        "y": 1040,
        "wires": []
    },
    {
        "id": "5f5325030cd4f6c0",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Unlink Luminarias",
        "func": "const sectorId = flow.get('deleteSectorId');\n\nmsg.collection = 'luminarias';\nmsg.query = { id_sector: sectorId };\nmsg.payload = { $set: { id_sector: null } };\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 1040,
        "wires": [
            [
                "6077696e4cea899d",
                "8a4922735ab4dd46"
            ]
        ]
    },
    {
        "id": "6077696e4cea899d",
        "type": "mongodb out",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "payonly": false,
        "upsert": false,
        "multi": true,
        "operation": "update",
        "x": 1060,
        "y": 1040,
        "wires": []
    },
    {
        "id": "8a4922735ab4dd46",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Format Response",
        "func": "msg.statusCode = 200;\nmsg.payload = {\n    success: true,\n    message: 'Sector eliminado exitosamente'\n};\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1290,
        "y": 1040,
        "wires": [
            [
                "0e6135c052ece62a"
            ]
        ]
    },
    {
        "id": "0e6135c052ece62a",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1500,
        "y": 1040,
        "wires": []
    },
    {
        "id": "37be99d64d32b5b2",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores/:id/luminarias",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1100,
        "wires": [
            [
                "e93a2e69b264fe28"
            ]
        ]
    },
    {
        "id": "e93a2e69b264fe28",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Luminarias con Mediciones",
        "func": "const sectorId = msg.req.params.id;\n\n// Buscar luminarias directamente por id_sector (que es el _id del sector como string)\nmsg.collection = 'luminarias';\nmsg.payload = [\n    {\n        $match: {\n            id_sector: sectorId\n        }\n    },\n    {\n        $addFields: {\n            // Extraer el número del id_lum (ej: \"lum_3\" -> 3)\n            lumNumerico: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$id_lum\", regex: \"^lum_[0-9]+$\" } },\n                    then: {\n                        $toInt: {\n                            $arrayElemAt: [\n                                { $split: [\"$id_lum\", \"_\"] },\n                                1\n                            ]\n                        }\n                    },\n                    else: null\n                }\n            }\n        }\n    },\n    {\n        $match: {\n            lumNumerico: { $ne: null }\n        }\n    },\n    {\n        $lookup: {\n            from: 'medicion',\n            let: { lumNum: '$lumNumerico' },\n            pipeline: [\n                {\n                    $match: {\n                        $expr: { $eq: ['$id_luminaria', '$$lumNum'] }\n                    }\n                },\n                {\n                    $addFields: {\n                        fechaNormalizada: {\n                            $cond: {\n                                if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                                then: \"$fecha\",\n                                else: { $concat: [\"$fecha\", \"Z\"] }\n                            }\n                        }\n                    }\n                },\n                {\n                    $addFields: {\n                        fechaDate: { \n                            $dateFromString: { \n                                dateString: \"$fechaNormalizada\",\n                                onError: null\n                            } \n                        }\n                    }\n                },\n                {\n                    $match: {\n                        fechaDate: { $ne: null }\n                    }\n                },\n                {\n                    $sort: { fechaDate: -1 }\n                },\n                {\n                    $limit: 1\n                }\n            ],\n            as: 'mediciones'\n        }\n    },\n    {\n        $addFields: {\n            ultimaMedicion: { $arrayElemAt: ['$mediciones', 0] }\n        }\n    },\n    {\n        $addFields: {\n            estado: {\n                $cond: {\n                    if: { $eq: ['$ultimaMedicion.falla', true] },\n                    then: 'Falla',\n                    else: {\n                        $cond: {\n                            if: { $eq: ['$ultimaMedicion.sobreconsumo', true] },\n                            then: 'Sobreconsumo',\n                            else: 'Bien'\n                        }\n                    }\n                }\n            }\n        }\n    },\n    {\n        $project: {\n            mediciones: 0,\n            lumNumerico: 0\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 1100,
        "wires": [
            [
                "267566bed0d7a06c"
            ]
        ]
    },
    {
        "id": "267566bed0d7a06c",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 780,
        "y": 1100,
        "wires": [
            [
                "9d37be24290ee7f7"
            ]
        ]
    },
    {
        "id": "9d37be24290ee7f7",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Respuesta",
        "func": "msg.payload = {\n    success: true,\n    data: msg.payload || []\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1000,
        "y": 1100,
        "wires": [
            [
                "8ac2c0774fc2354a"
            ]
        ]
    },
    {
        "id": "8ac2c0774fc2354a",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1220,
        "y": 1100,
        "wires": []
    },
    {
        "id": "a0c6616b26d67e79",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores/:id/detalle",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1180,
        "wires": [
            [
                "461e640126246b0c"
            ]
        ]
    },
    {
        "id": "461e640126246b0c",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Detalle Sector",
        "func": "const sectorId = msg.req.params.id;\nconst now = new Date();\nconst year = now.getFullYear();\nconst month = now.getMonth() + 1;\nconst daysInMonth = new Date(year, month, 0).getDate();\n\nflow.set('sectorId', sectorId);\nflow.set('daysInMonth', daysInMonth);\n\n// Buscar luminarias directamente por id_sector (que es el _id del sector como string)\nmsg.collection = 'luminarias';\nmsg.payload = [\n    {\n        $match: {\n            id_sector: sectorId\n        }\n    },\n    {\n        $addFields: {\n            // Extraer el número del id_lum (ej: \"lum_3\" -> 3)\n            lumNumerico: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$id_lum\", regex: \"^lum_[0-9]+$\" } },\n                    then: {\n                        $toInt: {\n                            $arrayElemAt: [\n                                { $split: [\"$id_lum\", \"_\"] },\n                                1\n                            ]\n                        }\n                    },\n                    else: null\n                }\n            }\n        }\n    },\n    {\n        $match: {\n            lumNumerico: { $ne: null }\n        }\n    },\n    {\n        $lookup: {\n            from: 'medicion',\n            let: { lumNum: '$lumNumerico' },\n            pipeline: [\n                {\n                    $match: {\n                        $expr: { $eq: ['$id_luminaria', '$$lumNum'] }\n                    }\n                },\n                {\n                    $addFields: {\n                        fechaNormalizada: {\n                            $cond: {\n                                if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                                then: \"$fecha\",\n                                else: { $concat: [\"$fecha\", \"Z\"] }\n                            }\n                        }\n                    }\n                },\n                {\n                    $addFields: {\n                        fechaDate: { \n                            $dateFromString: { \n                                dateString: \"$fechaNormalizada\",\n                                onError: null\n                            } \n                        }\n                    }\n                },\n                {\n                    $match: {\n                        fechaDate: { $ne: null }\n                    }\n                },\n                {\n                    $addFields: {\n                        mes: { $month: \"$fechaDate\" },\n                        anio: { $year: \"$fechaDate\" }\n                    }\n                },\n                {\n                    $match: {\n                        mes: month,\n                        anio: year\n                    }\n                },\n                {\n                    $sort: { fechaDate: -1 }\n                }\n            ],\n            as: 'mediciones'\n        }\n    },\n    {\n        $addFields: {\n            ultimaMedicion: { $arrayElemAt: ['$mediciones', 0] },\n            consumoTotal: { $sum: '$mediciones.consumo' }\n        }\n    },\n    {\n        $group: {\n            _id: null,\n            totalLuminarias: { $sum: 1 },\n            luminariasFuncionando: {\n                $sum: {\n                    $cond: [\n                        { $ne: ['$ultimaMedicion.falla', true] },\n                        1,\n                        0\n                    ]\n                }\n            },\n            luminariasConFalla: {\n                $sum: {\n                    $cond: [\n                        { $eq: ['$ultimaMedicion.falla', true] },\n                        1,\n                        0\n                    ]\n                }\n            },\n            luminariasConSobreconsumo: {\n                $sum: {\n                    $cond: [\n                        { $eq: ['$ultimaMedicion.sobreconsumo', true] },\n                        1,\n                        0\n                    ]\n                }\n            },\n            consumoTotal: { $sum: '$consumoTotal' }\n        }\n    },\n    {\n        $project: {\n            _id: 0,\n            totalLuminarias: 1,\n            luminariasFuncionando: 1,\n            luminariasConFalla: 1,\n            luminariasConSobreconsumo: 1,\n            consumoTotal: 1,\n            consumoPromedio: { $divide: ['$consumoTotal', daysInMonth] }\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 1180,
        "wires": [
            [
                "8247f5e45204ed03"
            ]
        ]
    },
    {
        "id": "8247f5e45204ed03",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 720,
        "y": 1180,
        "wires": [
            [
                "56d9b38e6ab03775"
            ]
        ]
    },
    {
        "id": "56d9b38e6ab03775",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Get Sector Info and Format",
        "func": "const sectorId = flow.get('sectorId');\nconst daysInMonth = flow.get('daysInMonth');\nconst stats = msg.payload[0] || {\n    totalLuminarias: 0,\n    luminariasFuncionando: 0,\n    luminariasConFalla: 0,\n    luminariasConSobreconsumo: 0,\n    consumoTotal: 0,\n    consumoPromedio: 0\n};\n\n// Buscar información del sector\nmsg.collection = 'sector';\n// Pasamos el ID como string, el nodo de MongoDB de Node-RED lo convertirá automáticamente a ObjectID si es válido\nif (sectorId.match(/^[0-9a-fA-F]{24}$/)) {\n    msg.payload = { _id: sectorId };\n} else {\n    msg.payload = { id_sector: sectorId };\n}\nmsg.stats = stats;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 980,
        "y": 1180,
        "wires": [
            [
                "6c6ecc4de295556d"
            ]
        ]
    },
    {
        "id": "6c6ecc4de295556d",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 1240,
        "y": 1180,
        "wires": [
            [
                "3cc3c4e26cf5d3d0"
            ]
        ]
    },
    {
        "id": "3cc3c4e26cf5d3d0",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Combine and Format",
        "func": "const sector = msg.payload || {};\nconst stats = msg.stats;\n\nmsg.payload = {\n    success: true,\n    data: {\n        _id: sector._id,\n        id_sector: sector.id_sector,\n        nombre: sector.nombre || 'Sector',\n        zona: sector.zona || 'Zona',\n        ...stats\n    }\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 1180,
        "wires": [
            [
                "880b0fc85b5d92f9"
            ]
        ]
    },
    {
        "id": "880b0fc85b5d92f9",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1690,
        "y": 1180,
        "wires": []
    },
    {
        "id": "fae36f04a2490a50",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores/estado",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1260,
        "wires": [
            [
                "1c4659f099bae765"
            ]
        ]
    },
    {
        "id": "1c4659f099bae765",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Estado Sectores",
        "func": "// Obtener última medición de cada luminaria agrupada por sector\nmsg.collection = 'luminarias';\nmsg.payload = [\n    {\n        $addFields: {\n            // Extraer el número del id_lum (ej: \"lum_3\" -> 3)\n            lumNumerico: {\n                $cond: {\n                    if: { $regexMatch: { input: \"$id_lum\", regex: \"^lum_[0-9]+$\" } },\n                    then: {\n                        $toInt: {\n                            $arrayElemAt: [\n                                { $split: [\"$id_lum\", \"_\"] },\n                                1\n                            ]\n                        }\n                    },\n                    else: null\n                }\n            }\n        }\n    },\n    {\n        $match: {\n            lumNumerico: { $ne: null }\n        }\n    },\n    {\n        $lookup: {\n            from: 'medicion',\n            let: { lumNum: '$lumNumerico' },\n            pipeline: [\n                {\n                    $match: {\n                        $expr: { $eq: ['$id_luminaria', '$$lumNum'] }\n                    }\n                },\n                {\n                    $addFields: {\n                        fechaNormalizada: {\n                            $cond: {\n                                if: { $regexMatch: { input: \"$fecha\", regex: \"Z$\" } },\n                                then: \"$fecha\",\n                                else: { $concat: [\"$fecha\", \"Z\"] }\n                            }\n                        }\n                    }\n                },\n                {\n                    $addFields: {\n                        fechaDate: { \n                            $dateFromString: { \n                                dateString: \"$fechaNormalizada\",\n                                onError: null\n                            } \n                        }\n                    }\n                },\n                {\n                    $match: {\n                        fechaDate: { $ne: null }\n                    }\n                },\n                {\n                    $sort: { fechaDate: -1 }\n                },\n                {\n                    $limit: 1\n                }\n            ],\n            as: 'mediciones'\n        }\n    },\n    {\n        $addFields: {\n            ultimaMedicion: { $arrayElemAt: ['$mediciones', 0] }\n        }\n    },\n    {\n        $group: {\n            _id: '$id_sector',\n            tieneFalla: {\n                $max: {\n                    $cond: [\n                        { $eq: ['$ultimaMedicion.falla', true] },\n                        1,\n                        0\n                    ]\n                }\n            },\n            tieneSobreconsumo: {\n                $max: {\n                    $cond: [\n                        { $eq: ['$ultimaMedicion.sobreconsumo', true] },\n                        1,\n                        0\n                    ]\n                }\n            }\n        }\n    },\n    {\n        $project: {\n            _id: 0,\n            id_sector: '$_id',\n            falla: { $eq: ['$tieneFalla', 1] },\n            sobreconsumo: { $eq: ['$tieneSobreconsumo', 1] }\n        }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 1260,
        "wires": [
            [
                "67457a872ed0dd05"
            ]
        ]
    },
    {
        "id": "67457a872ed0dd05",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 700,
        "y": 1260,
        "wires": [
            [
                "33f155996a1087cf"
            ]
        ]
    },
    {
        "id": "33f155996a1087cf",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Estado Sectores",
        "func": "// Crear un mapa de estados por sector\nconst estadosPorSector = {};\n\nif (msg.payload && msg.payload.length > 0) {\n    msg.payload.forEach(item => {\n        estadosPorSector[item.id_sector] = {\n            falla: item.falla || false,\n            sobreconsumo: item.sobreconsumo || false\n        };\n    });\n}\n\nmsg.payload = {\n    success: true,\n    data: estadosPorSector\n};\n\nmsg.statusCode = 200;\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': '*'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 960,
        "y": 1260,
        "wires": [
            [
                "c344f03882c1454f"
            ]
        ]
    },
    {
        "id": "c344f03882c1454f",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "x": 1190,
        "y": 1260,
        "wires": []
    },
    {
        "id": "65016b8d41a78754",
        "type": "mongodb",
        "hostname": "cluster0.gne8ies.mongodb.net",
        "topology": "dnscluster",
        "connectOptions": "",
        "port": "27017",
        "db": "LumiCert",
        "name": "MongoDB Atlas"
    },
    {
        "id": "a1a2a3a4a5a6a7a8",
        "type": "http in",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "url": "/api/sectores/:id/consumo-mensual",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1000,
        "wires": [
            [
                "b2b3b4b5b6b7b8b9"
            ]
        ]
    },
    {
        "id": "b2b3b4b5b6b7b8b9",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Consumo Mensual Sector",
        "func": "const sectorId = msg.req.params.id;\nconst now = new Date();\nconst currentYear = now.getFullYear();\n\nmsg.collection = 'luminarias';\nmsg.payload = [\n    {\n        $match: {\n            id_sector: sectorId\n        }\n    },\n    {\n        $project: {\n            id_lum: 1\n        }\n    }\n];\n\nflow.set('sectorId', sectorId);\nflow.set('currentYear', currentYear);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 1000,
        "wires": [
            [
                "c3c4c5c6c7c8c9c0"
            ]
        ]
    },
    {
        "id": "c3c4c5c6c7c8c9c0",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 740,
        "y": 1000,
        "wires": [
            [
                "d4d5d6d7d8d9d0d1"
            ]
        ]
    },
    {
        "id": "d4d5d6d7d8d9d0d1",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Query Consumo por Luminarias",
        "func": "const luminarias = msg.payload || [];\nconst currentYear = flow.get('currentYear');\n\nif (luminarias.length === 0) {\n    msg.payload = [];\n    return msg;\n}\n\nconst lumIds = luminarias.map(l => l.id_lum);\n\nmsg.collection = 'consumo_mensual';\nmsg.payload = [\n    {\n        $match: {\n            id_lum: { $in: lumIds },\n            id_year: `year_${currentYear}`\n        }\n    },\n    {\n        $group: {\n            _id: '$id_month',\n            consumoTotal: { $sum: '$consumoMensual' }\n        }\n    },\n    {\n        $sort: { _id: 1 }\n    }\n];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1000,
        "y": 1000,
        "wires": [
            [
                "e5e6e7e8e9e0e1e2"
            ]
        ]
    },
    {
        "id": "e5e6e7e8e9e0e1e2",
        "type": "mongodb in",
        "z": "7c7613f3e7ca3f2d",
        "mongodb": "65016b8d41a78754",
        "name": "",
        "collection": "",
        "operation": "aggregate",
        "x": 1260,
        "y": 1000,
        "wires": [
            [
                "f6f7f8f9f0f1f2f3"
            ]
        ]
    },
    {
        "id": "f6f7f8f9f0f1f2f3",
        "type": "function",
        "z": "7c7613f3e7ca3f2d",
        "name": "Formatear Respuesta",
        "func": "const data = msg.payload || [];\nconst monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];\n\n// Crear array con todos los meses inicializados en 0\nconst consumoPorMes = monthNames.map((mes, index) => ({\n    mes: mes,\n    consumo: 0\n}));\n\n// Llenar con datos reales\ndata.forEach(item => {\n    const monthIndex = parseInt(item._id.replace('month_', ''));\n    if (monthIndex >= 0 && monthIndex < 12) {\n        consumoPorMes[monthIndex].consumo = item.consumoTotal;\n    }\n});\n\nmsg.payload = {\n    success: true,\n    data: consumoPorMes\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1520,
        "y": 1000,
        "wires": [
            [
                "g7g8g9g0g1g2g3g4"
            ]
        ]
    },
    {
        "id": "g7g8g9g0g1g2g3g4",
        "type": "http response",
        "z": "7c7613f3e7ca3f2d",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1750,
        "y": 1000,
        "wires": []
    },
    {
        "id": "7e6fbc903fa14603",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-mongodb": "0.2.5"
        }
    }
]